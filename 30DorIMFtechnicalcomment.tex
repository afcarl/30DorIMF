\documentclass[apjl]{emulateapj}

\usepackage{hyperref}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{graphicx}
\usepackage{color}
\usepackage{natbib}

\newcommand{\MSun}{M_\odot}
\newcommand{\RSun}{R_\odot}
\newcommand{\Rstar}{R_*}
\newcommand{\Mstar}{m_*}
\newcommand{\MBH}{M_\mathrm{BH}}

\def\aj{Astronomical Journal}                 % Astronomical Journal
\def\apj{Astrophysical Journal}                % Astrophysical Journal
\def\apjl{Astrophysical Journal}             % Astrophysical Journal, Letters
\def\pasj{PASJ}
\def\apjs{ApJS}              % Astrophysical Journal, Supplement
\def\mnras{MNRAS}            % Monthly Notices of the RAS
\def\prd{Phys.~Rev.~D}       % Physical Review D
\def\prl{Phys.~Rev.~Lett}    % Physical Review Letters
\def\cqg{Class.~Quant.~Grav.~}%Classical and Quantum Gravity
\def\araa{ARA\&A}             % Annual Review of Astron and Astrophys
\def\nat{Nature}              % Nature
\def\aap{A\&A}                % Astronomy and Astrophysics
\def\na{New Astronomy}

\newcommand{\will}[1]{\textcolor{cyan}{#1}}
\newcommand{\ilya}[1]{\textcolor{red}{#1}}

\newcommand{\onesigrange}[3]{\ensuremath{#1^{+#2}_{-#3}}}
\newcommand{\alpharangeone}{\onesigrange{2.05}{0.14}{0.13}}
\newcommand{\alpharangetwo}{\onesigrange{2.05}{0.14}{0.13}}
\newcommand{\alpharangethree}{\onesigrange{2.11}{0.19}{0.17}}
\newcommand{\alpharangefour}{\onesigrange{2.15}{0.13}{0.13}}

\begin{document}

\title{Comment on ``An excess of massive stars in the local 30 Doradus starburst''}

\author{Will M. Farr\altaffilmark{1}, Ilya Mandel\altaffilmark{1}}
\affil{$^1$Institute of Gravitational Wave Astronomy and School of Physics and Astronomy, University of Birmingham, Birmingham, B15 2TT, United Kingdom}
\email{wmfarr@star.sr.bham.ac.uk, imandel@star.sr.bham.ac.uk}

\begin{abstract}
%
Schneider et al.~(Reports, 5 January 2018, p.~69) found more stars above 30
solar masses than predicted by a standard Salpeter initial mass function (IMF)
in the 30 Doradus star-forming region.  They find IMF power-law exponent of
$1.90^{+0.37}_{-0.26}$ in contrast to the Salpeter exponent of $2.35$; however,
the significant statistical uncertainty in their result is based on a flawed
analysis of the data. Correcting this error we infer an exponent of
$\alpharangeone$.  Although the mean of our posterior on the exponent suggests a
steeper IMF, it is in fact more statistically significantly different (about
2-$\sigma$) from the Salpeter value of $2.35$.  We discuss the impact of
assumptions regarding data set completeness and the star formation history
model; alternative assumptions can shift the inferred exponent to
$\alpharangethree$ and $\alpharangefour$, respectively.  We also consider an
additional break in the IMF power law, but do not find convincing evidence for
such a break.
%
\end{abstract}

\maketitle

The universality of the initial mass function of stars is a hot topic in modern
astrophysics, with impact on galactic evolution, supernovae, and
gravitational-wave sources
\citep{Kroupa:2002,Bastian:2010,deMinkBelczynski:2015}.
\citet{Schneider:2018} use spectroscopic observations of young massive stars in
the 30 Doradus region of the Large Magellanic Cloud to infer a
shallower-than-expected IMF.  They estimate the ages and masses of individual
stars with the BONNSAI Bayesian code \citep{Schneider:2017}.  They then obtain
an overall mass distribution by effectively adding together the posterior
probability density functions of individual stars.  There is no statistical
meaning to a distribution obtained in this way, and it does not represent the
posterior probability density function on the observed mass distribution.

%Their conclusion is due to a faulty statistical methodology and several questionable assumptions which we discuss below.

%\citet{Schneider:2018} estimate the ages and masses of individual stars with the BONNSAI Bayesian code \citep{Schneider:2017}.  They then obtain an overall mass distribution by effectively adding together the posterior probability density functions of individual stars.  There is no statistical meaning to a distribution obtained in this way, and it does not represent the posterior probability density function on the underlying mass distribution.  %In fact, when the underlying distribution is a steeply decaying power law, as considered here, the approach of \citet{Schneider:2018} will yield a distribution biased toward the high-mass end.  The measurement uncertainty will ``smear out'' the masses of both low-mass and high-mass stars, but because there are far more low-mass stars than high-mass ones, this appears to yield more mass at the high end of the distribution, leading to a false conclusion of a shallower distribution.

Hierarchical Bayesian inference provides the statistically correct solution to
this problem \citep{Hogg:2010}.  \citet{Mandel:2010stat} specifically considered
inference on a mass distribution given a sample of uncertain measurements, and
we use a similar methodology here.  We interpret the \citet{Schneider:2018}
inference on individual masses and ages as independent Gaussian likelihoods for
the log of the mass and the age, with parameters fixed by matching the mean
parameter to the peak and the standard deviation parameter to the 68\% width of
the individual stellar distributions in the \citet{Schneider:2018} data.  We
have performed fits similar to those described here using a heavier-tailed,
Student T likelihood with few degrees of freedom and find equivalent results,
suggesting that heavy tails in the likelihood are not particularly influential
in this analysis.

For our fiducial analysis we model the star formation history as a truncated Gaussian distribution, and
generally find similar star formation history to \citet{Schneider:2018}, with
the star formation rate peaking in 30 Dor about 4 Mya.  We impose broad priors
on the power--law exponent and the mean and standard deviation of the star
formation Gaussian.    We use the Hamiltonian Monte Carlo sampler STAN
\citep{STAN} to efficiently address the high-dimensional hierarchical problem
with free parameters for each star's actual mass and birth age in addition to
the IMF exponent and the mean and standard deviation of the star formation
history.

Figure \ref{fig:IMF} shows the inferred power-law exponent of the IMF.   When
using the \citet{Schneider:2018}  fit to stellar lifetimes and following the assumption
that their data set is complete above 15 solar masses (i.e.\ selecting only
those stars whose observed mass is above $15 \, M_\odot$
\citep{Loredo:2004,BBH:O1}), we find
an exponent of $\alpharangeone$ where the quoted value corresponds to the median
of the posterior distribution and the range to the 16th and 84th percentiles
(i.e.\ the symmetric 68\% credible interval).  Correcting the erroneous
statistical procedure used by \citet{Schneider:2018} steepens the preferred IMF
slope and narrows the uncertainty interval; the preferred value from
\citet{Schneider:2018} lies about $1\, \sigma$ below our median value.

The analysis above used the same assumptions as \citet{Schneider:2018}.  Below, we consider the impact of three additional questionable assumptions: the stellar lifetime fit; the choice of the completeness limit; and the model for the star formation history.

%The fit to stellar lifetimes used by \citet{Schneider:2018} continues to decrease at high masses, in contrast to the expectation that stellar lifetimes should asymptote to a fixed minimum duration for high-mass stars set by the ratio of the energy to be released through nuclear fusion to the Eddington luminosity.
We make an independent fit to the main sequence lifetimes
$\tau_{MS}$ of non-rotating massive stars as modelled by \citet{Brott:2011} and \citet{Kohler:2015} (in
our models, following \citet{Schneider:2018}, we increase the ``observable''
lifetime of a star by 10\% beyond its main sequence lifetime to account for
helium burning):
%
\begin{multline}
\ln \frac{\tau_{MS} (M)}{\textrm{Myr}} = 9.1973 - 3.8955 \ln\frac{M}{M_\odot} \\ + 0.6107 \left(\ln\frac{M}{M_\odot} \right)^2 - 0.0332 \left(\ln\frac{M}{M_\odot}\right)^3.
\end{multline}
%Our fit predicts longer lifetimes for stars more massive than $\sim 100 M_\odot$ than the \citet{Schneider:2018} fit.  Using our fit rather than the \citet{Schneider:2018} fit therefore leads to a steeper power-law exponent, $\alpharangetwo$, as there are fewer massive stars that should have already collapsed into invisible remnants in our model.
We find that this alternative fit does not impact the inferred IMF, yielding a power-law exponent $\alpharangetwo$.

The inferred power-law exponent is somewhat sensitive to
the choice of the cutoff mass for survey completeness.  The data of \citet{Schneider:2018} show a relative scarcity of stars between 15 and 20 solar masses; changing the mass cutoff from $15 M_\odot$ to $20 M_\odot$ further steepens the inferred exponent to $\alpharangethree$.    However, these fluctuations are within the expected statistical
variation based on the sample size, as confirmed with posterior predictive
checking.  In particular, we do not claim statistical evidence against the claim of \citet{Schneider:2018} that
the survey is complete for $M \geq 15 \, \MSun$.

Finally, we consider an alternative star formation history model: a double exponential, with three free parameters: the time of the peak of the star formation rate and the (possibly different) decay constants before and after the peak.  This model allows for a sharper peak and longer tails than a Gaussian.  This star formation rate history model is consistent with the data, as tested with posterior predictive checking (see below).  However, it yields a power-law exponent $\alpharangefour$, almost  $1\, \sigma$ steeper than for our fiducial analysis.  This indicates that the inferred IMF is sensitive to the systematics of the assumed model.

\begin{figure}
\includegraphics[width=\columnwidth]{alpha.pdf}
    		\caption{The posterior inferred on the power-law exponent under four models (see text for details): \citet{Schneider:2018} stellar lifetimes, survey completeness for $M \geq 15 \, \MSun$, and Gaussian star formation history model (blue); as before, but with our lifetime fit (green); as before, but with completeness for $M \geq 20 \, \MSun$ (orange); as blue, but with a double-exponential star formation history model (pink).  The Salpeter power-law exponent is $-\alpha=-2.35$ \citep{Salpeter:1955}, indicated by a black line.  The 68.3\% range of power-law exponents derived by \citet{Schneider:2018} is shaded in grey. }\label{fig:IMF}
\end{figure}

We also considered the possibility that the IMF power law has an extra break at higher masses, allowing for three free parameters: the mass at which the break happens and the exponent below and above the break.  However, we find that the data are insufficient to constrain the parameters of this more general model, and there is no preference for a broken power-law model.

We confirm the stability of our conclusions with posterior predictive checking.
Figure \ref{fig:PPC} shows the distribution of observed masses and ages (i.e.,
the peak of the likelihood) from the \citet{Schneider:2018} data on top of the
range of mass and age distributions that would be observed from a large number
of data sets drawn according to our fitted IMF model.  The data can be seen to
be consistent with our IMF model.  We have also confirmed that all of our models yield predictions for the numbers of stars heavier than $30 M_\odot$ and $60 M_\odot$ that are consistent with observations.

\begin{figure}
%\vspace{-1in}
    		    		\includegraphics[width=\columnwidth]{dNdm-ppc-band.pdf}\\
                \includegraphics[width=\columnwidth]{dNdt-ppc-band.pdf}
%\vspace{-1in}
    		\caption{The observed distribution of (maximum likelihood) masses (top, black) and ages (bottom, black) and the range (median, 68\%, and 95\% credible intervals in blue) of distributions of mass and age from synthetic data drawn from our fitted model (i.e.\ the posterior predictive distribution).  The observed data are consistent with being drawn from our model.  %We see no evidence that our model is unable to account for the features in the observed data, including the apparent shallowing of the exponent of the mass distribution for $M \gtrsim 60 \, \MSun$.
		}\label{fig:PPC}
\end{figure}


We find that we can significantly reduce the statistical uncertainty in the IMF by applying the correct statistical analysis to the observations of young massive stars in 30 Doradus.  However, the systematics from modelling uncertainties, such as the assumed star formation history model, can potentially shift the inferred power-law exponent by more than the statistical uncertainty.   Furthermore, we adopted the mass and age posteriors for individual stars directly from \citet{Schneider:2018}.  Although we do not discuss the possible systematic uncertainty on these due to imperfect stellar models or the inclusion of other complicating factors described by \citet{Schneider:2018} (rotation, mass transfer, mergers, etc.), any systematics could again shift the inferred IMF exponent.
The combination of these factors makes it very challenging to infer the precise shape of the IMF even when a data set as good as that obtained by is \citet{Schneider:2018} available.


\acknowledgments

%While this note is critical of the conclusions in \citet{Schneider:2018}, those authors should be
We are grateful to \citet{Schneider:2018} for making the data on which their conclusions are
based available for further study and analysis, and to Fabian Schneider personally for very useful discussions.  This analysis made use of \texttt{PySTAN} \citep{PySTAN}, \texttt{astropy} \citep{astropy}, \texttt{numpy} \citep{numpy}, \texttt{scipy} \citep{scipy}, \texttt{matplotlib} \citep{matplotlib}, and \texttt{seaborn} \citep{seaborn} Python libraries.  The code and \LaTeX source used to prepare this document are publicly available under an open-source MIT license at \url{https://github.com/farr/30DorIMF}.  WMF and IM are partially supported by STFC.

\bibliographystyle{hapj}
\bibliography{Mandel}
\end{document}
